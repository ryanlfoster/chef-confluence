<?xml version='1.0' encoding='utf-8'?>
<!--
  Dynamically generated by Chef on <%= node["fqdn"] %>
  Local modifications will be overwritten by Chef.
-->
<Server port="8000" shutdown="SHUTDOWN" debug="0">
    <Service name="Tomcat-Standalone">
        <Connector className="org.apache.coyote.tomcat4.CoyoteConnector"
                   port="<%= node['confluence']['tomcat']['port'] %>" protocol="HTTP/1.1"
                   minProcessors="5"
                   maxProcessors="75"
                   enableLookups="false"
                   acceptCount="10"
                   debug="0"
                   connectionTimeout="20000"
                   useURIValidationHack="false"
                   URIEncoding="UTF-8"
                   useBodyEncodingForURI="true"
                   compression="on"
                   compressableMimeType="text/html,text/xml,text/plain,text/css,application/json,application/javascript,application/x-javascript"
                   <% if node['confluence']['apache2'] -%>
                   redirectPort="<%= node['confluence']['apache2']['ssl']['port'] %>"
                   secure="true"
                   scheme="https"
                   proxyName="<%= node['confluence']['apache2']['virtual_host_alias'] %>"
                   proxyPort="<%= node['confluence']['apache2']['ssl']['port'] %>"
                   <% else -%>
                   redirectPort="<%= node['confluence']['tomcat']['ssl_port'] %>"
                   <% end -%>
        />

        <Connector port="<%= node['confluence']['tomcat']['ssl_port'] %>"
             maxHttpHeaderSize="8192"
             maxThreads="150"
             minSpareThreads="25"
             maxSpareThreads="75"
             enableLookups="false"
             disableUploadTimeout="true"
             acceptCount="100"
             scheme="https"
             secure="true"
             clientAuth="false"
             SSLEnabled="true"
             sslProtocol="TLS"
             <%- if @tomcat %>
             <%= "keyAlias=\"#{@tomcat['keyAlias']}\"" if @tomcat['keyAlias'] %>
             <%= "keystoreFile=\"#{@tomcat['keystoreFile']}\"" if @tomcat['keystoreFile'] %>
             <%= "keystorePass=\"#{@tomcat['keystorePass']}\"" if @tomcat['keystorePass'] %>
             <%- end %>
        />

        <Engine name="Standalone" defaultHost="localhost" debug="0">
            <Host name="localhost" debug="0" appBase="webapps" unpackWARs="true" autoDeploy="true">
                <Context path="<%= node['confluence']['context'].empty? ? '' : '/' + node['confluence']['context'] %>" docBase="../confluence" debug="0" reloadable="false" useHttpOnly="true">
                  <Manager pathname="" />
                </Context>
            </Host>
        </Engine>
    </Service>
</Server>
